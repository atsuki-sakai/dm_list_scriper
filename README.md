# HotPepper Beauty サロンスクレイパー

HotPepper Beauty のサロン情報を階層的にスクレイピングし、詳細情報を取得するTypeScriptアプリケーションです。

## 🎯 機能概要

- **階層的エリア選択**: 地域 → サブエリア → 詳細エリアの3段階で絞り込み
- **柔軟なサロン選択**: 最後のサロン、名前検索、一覧から選択の3つの方法
- **詳細情報取得**: 住所、営業時間、料金、設備など13項目の情報を構造化して取得
- **Google検索統合**: Instagram URL、メールアドレス、ホームページURLを自動取得
- **Google Business情報**: 評価、レビュー数、営業時間などのビジネス情報を収集
- **バルク処理**: 複数のサロン情報を一括で処理し、CSV形式でエクスポート
- **スマートファイル名生成**: エリア名と処理割合を含む分かりやすいCSVファイル名を自動生成
- **429エラー対応**: レート制限発生時の自動エンジン無効化で安定した処理を実現
- **ページネーション対応**: 複数ページにまたがるサロン一覧を自動処理

## 🚀 クイックスタート

### 1. インストール
```bash
pnpm install
```

### 2. 環境設定（オプション）
Google Custom Search APIを使用する場合は、`.env.example`を`.env`にコピーして設定：
```bash
cp .env.example .env
```

`.env`ファイルに以下を設定：
- `GOOGLE_API_KEY`: Google Custom Search APIキー
- `GOOGLE_SEARCH_ENGINE_ID`: カスタム検索エンジンID

※設定しない場合は、Bing、Yahooの検索エンジンが使用されます。

### 3. 実行
```bash
pnpm start
```

### 4. 使用方法
1. 地域を選択（1-9の数字または地域名）
2. サブエリアを選択（表示された選択肢から）
3. 詳細エリアを選択（表示された選択肢から）
4. サロン選択方法を選択
   - `1`: 最後のサロン（自動）
   - `2`: サロン名で検索
   - `3`: 一覧から手動選択
   - `4`: バルク処理（50%のサロンをCSV出力）
   - `5`: 全件バルク処理（100%のサロンをCSV出力）
5. サロン詳細情報が表示されます

## 📋 バルク処理とCSVエクスポート

### CSVファイル名の自動生成
バルク処理では、エリア選択情報と処理割合を含む分かりやすいファイル名が自動生成されます：

```
例：中国_島根_益田浜田_50%.csv
例：関東_東京都_渋谷区_100%.csv
```

### バルク処理オプション
- **50%処理**: 対象エリアのサロンの半数を処理（効率的なサンプリング）
- **100%処理**: 対象エリアの全サロンを処理（完全なデータ収集）

## 🔍 検索エンジン機能

### 利用可能な検索エンジン
1. **Google Custom Search API**（推奨・最優先）
2. **Bing検索**
3. **Yahoo検索**

### 自動エラー処理機能
- **429エラー対応**: レート制限に達した検索エンジンを自動的に無効化
- **フォールバック機能**: 一つの検索エンジンが無効化されても他のエンジンで継続
- **効率的な検索**: Instagram URLが見つかった時点で早期終了

### 検索エンジンの優先順位
1. Google Custom Search API → 2. Bing → 3. Yahoo の順で実行
2. いずれかでInstagram URLが見つかった時点で他の検索エンジンをスキップ
3. 429エラーが発生したエンジンは以降の処理で自動的にスキップ

## 📁 プロジェクト構造

```
src/
├── scraper.ts                     # メインエントリーポイント
├── types/                         # 型定義
├── constants/                     # 定数・設定値
├── utils/                         # ユーティリティ関数
├── services/                      # ビジネスロジック
│   ├── scraper.ts                # スクレイピング機能
│   ├── googleSearch.ts           # Google検索統合
│   ├── csvExport.ts              # CSV出力機能
│   ├── userInput.ts              # ユーザー入力処理
│   └── display.ts                # 表示処理
└── controllers/                   # 制御ロジック
    ├── areaController.ts         # エリア選択制御
    ├── salonController.ts        # サロン処理制御
    └── bulkSalonController.ts    # バルク処理制御
```

## 🔧 収集される情報

### サロン基本情報
- サロン名
- 住所
- アクセス・道案内
- 営業時間
- 定休日
- カット価格
- 席数
- スタッフ数
- 駐車場
- 支払い方法
- こだわり条件
- 備考

### Google検索で追加される情報
- Instagram URL
- メールアドレス
- ホームページURL
- Google Business情報
  - 評価（★評価）
  - レビュー数
  - 営業時間
  - 営業状況
  - 電話番号（Google Businessのみ）

## 📊 出力形式

### CSVファイル構造
バルク処理で生成されるCSVファイルには以下の情報が含まれます：
- 全てのサロン基本情報（13項目）
- Google検索で取得したソーシャルメディア情報
- Google Business情報（利用可能な場合）

### ファイル名規則
```
{メインエリア}_{サブエリア}_{詳細エリア}_{処理割合}%.csv
```

## 📚 ドキュメント

詳細なドキュメントは`docs/`ディレクトリを参照してください：
- [Architecture.md](./docs/Architecture.md) - 設計思想・アーキテクチャ詳細
- [API.md](./docs/API.md) - API リファレンス・関数仕様
- [Development.md](./docs/Development.md) - 開発ガイド・拡張方法

## 🛠 技術スタック

- **言語**: TypeScript
- **ランタイム**: Node.js
- **パッケージマネージャー**: pnpm
- **スクレイピング**: axios + cheerio
- **アーキテクチャ**: 階層化アーキテクチャ（レイヤードアーキテクチャ）

## 📋 要件

- Node.js 18以上
- pnpm 8以上

## 📝 ライセンス

ISC